<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NewsCentral Admin Panel</title>
  <link rel="stylesheet" href="assets/css/admin.css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #E0E0E0; font-family: 'Roboto', sans-serif; }
    .admin-container {
      display: flex;
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
    }
    .admin-sidebar {
      width: 240px;
      background: #2196F3;
      color: #fff;
      min-height: 100vh;
      height: 100vh;
      position: relative;
      z-index: 2;
      box-shadow: 2px 0 8px #0001;
      display: flex;
      flex-direction: column;
    }
    .admin-main {
      flex: 1;
      overflow-y: auto;
      height: 100vh;
      background: transparent;
      padding-bottom: 2rem;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .metric-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }
    .metric-card.orange .icon { color: #FF9800; }
    .metric-card.blue .icon { color: #2196F3; }
    .metric-card.green .icon { color: #43A047; }
    .metric-card.gray .icon { color: #888; }
    .metric-value {
      font-size: 2.1rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }
    .metric-label {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }
    .metric-subtext {
      font-size: 0.95rem;
      color: #888;
      text-align: center;
    }
    .dashboard-charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
    .chart-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 1.5rem 1rem 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 50%;
      min-width: 180px;
      max-width: 240px;
      margin: 0 auto;
    }
    .chart-card h3 {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 0.7rem;
      color: #2196F3;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .chart-card h3 i {
      font-size: 0.65rem;
      color: #888;
      margin-right: 0.15rem;
      vertical-align: middle;
    }
    .recent-posts {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 1.5rem 1.5rem 2rem 1.5rem;
      margin-bottom: 2rem;
    }
    .recent-posts h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #FF9800;
      margin-bottom: 1rem;
    }
    #recent-posts-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #recent-posts-list li {
      padding: 0.7rem 0;
      border-bottom: 1px solid #eee;
      font-size: 1.05rem;
      color: #333;
    }
    #recent-posts-list li:last-child { border-bottom: none; }
    @media (max-width: 1100px) {
      .dashboard-grid { grid-template-columns: 1fr 1fr; }
      .dashboard-charts { grid-template-columns: 1fr; }
    }
    @media (max-width: 700px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .dashboard-charts { grid-template-columns: 1fr; }
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7QZ3DW9JKY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7QZ3DW9JKY');
  </script>
</head>
<body>
  <div class="admin-container">
    <aside class="admin-sidebar">
      <h2>Admin Panel</h2>
      <nav>
        <ul>
          <li><a href="#dashboard" class="active">Dashboard</a></li>
          <li><a href="#articles">Articles</a></li>
          <li><a href="#categories">Categories</a></li>
          <li><a href="#languages">Languages</a></li>
          <li><a href="#users">Users</a></li>
          <li><a href="#analytics">Analytics</a></li>
        </ul>
      </nav>
    </aside>
    <main class="admin-main" id="admin-main">
      <!-- Dashboard Content -->
      <section class="dashboard-grid">
        <div class="metric-card orange">
          <div class="icon"><i class="fas fa-book"></i></div>
          <div class="metric-value" id="total-articles">0</div>
          <div class="metric-label">Total Articles</div>
          <div class="metric-subtext">Number of published articles</div>
        </div>
        <div class="metric-card blue">
          <div class="icon"><i class="fas fa-folder"></i></div>
          <div class="metric-value" id="total-categories">0</div>
          <div class="metric-label">Categories</div>
          <div class="metric-subtext">Number of news categories</div>
        </div>
        <div class="metric-card green">
          <div class="icon"><i class="fas fa-globe"></i></div>
          <div class="metric-value" id="total-languages">0</div>
          <div class="metric-label">Languages</div>
          <div class="metric-subtext">Number of supported languages</div>
        </div>
        <div class="metric-card gray">
          <div class="icon"><i class="fas fa-users"></i></div>
          <div class="metric-value" id="total-users">0</div>
          <div class="metric-label">Registered Users</div>
          <div class="metric-subtext">Total registered users (dummy)</div>
        </div>
      </section>
      <section class="dashboard-charts">
        <div class="chart-card">
          <h3>Articles by Language</h3>
          <canvas id="langBarChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Articles by Category</h3>
          <canvas id="catPieChart"></canvas>
        </div>
      </section>
      <section class="recent-posts">
        <h3>Recent Posts</h3>
        <ul id="recent-posts-list"></ul>
      </section>
      <div class="change-pass-box">
        <h2 style="color:orange;text-align:center;">Change Admin Password</h2>
        <div class="msg" id="changeMsg"></div>
        <form id="changePassForm" autocomplete="off">
          <label for="oldPass">Current Password</label>
          <input type="password" id="oldPass" required placeholder="Current password">
          <label for="newPass">New Password</label>
          <input type="password" id="newPass" required placeholder="New password">
          <label for="confirmPass">Confirm New Password</label>
          <input type="password" id="confirmPass" required placeholder="Confirm new password">
          <button type="submit">Change Password</button>
        </form>
      </div>
    </main>
    <button id="openPassModal" style="position:fixed;bottom:24px;left:24px;z-index:1000;background:#FF9800;color:#fff;border:none;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 12px #0003;font-size:1.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;" title="Change Admin Password"><i class="fas fa-key"></i></button>
    <div id="passModalBackdrop" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0007;z-index:1001;"></div>
    <div id="passModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;z-index:1002;padding:2.2rem 1.5rem 1.5rem 1.5rem;border-radius:16px;box-shadow:0 4px 32px #0003;min-width:320px;max-width:95vw;width:100%;max-width:370px;">
      <h2 style="color:#FF9800;text-align:center;margin-bottom:1.2rem;font-size:1.5rem;letter-spacing:0.5px;">Change Admin Password</h2>
      <div class="msg" id="changeMsgModal" style="min-height:22px;text-align:center;font-size:1.05rem;margin-bottom:0.5rem;"></div>
      <form id="changePassFormModal" autocomplete="off" style="display:flex;flex-direction:column;gap:0.7rem;">
        <label for="oldPassModal" style="font-weight:600;color:#333;font-size:1.05rem;">Current Password</label>
        <input type="password" id="oldPassModal" required placeholder="Current password" style="width:100%;padding:0.7rem 1rem;border:1.5px solid #bbb;border-radius:7px;font-size:1.08rem;">
        <label for="newPassModal" style="font-weight:600;color:#333;font-size:1.05rem;">New Password</label>
        <input type="password" id="newPassModal" required placeholder="New password" style="width:100%;padding:0.7rem 1rem;border:1.5px solid #bbb;border-radius:7px;font-size:1.08rem;">
        <label for="confirmPassModal" style="font-weight:600;color:#333;font-size:1.05rem;">Confirm New Password</label>
        <input type="password" id="confirmPassModal" required placeholder="Confirm new password" style="width:100%;padding:0.7rem 1rem;border:1.5px solid #bbb;border-radius:7px;font-size:1.08rem;">
        <button type="submit" style="width:100%;background:#FF9800;color:#fff;border:none;border-radius:7px;padding:0.85rem 0;font-size:1.13rem;font-weight:700;margin-top:0.7rem;box-shadow:0 2px 8px #FF980033;">Change Password</button>
        <button type="button" id="closePassModal" style="width:100%;margin-top:0.5rem;background:#eee;color:#333;border:none;border-radius:7px;padding:0.8rem 0;font-size:1.08rem;font-weight:500;">Cancel</button>
      </form>
    </div>
    <style>
      @media (max-width: 600px) {
        #passModal {
          min-width: unset !important;
          width: 98vw !important;
          max-width: 98vw !important;
          padding: 1.2rem 0.5rem 1rem 0.5rem !important;
        }
        #passModal h2 {
          font-size: 1.15rem !important;
        }
        #passModal input, #passModal button {
          font-size: 1rem !important;
        }
      }
      #passModal input:focus {
        border-color: #2196F3;
        outline: none;
        background: #f5faff;
      }
      #passModal button[type="submit"]:hover {
        background: #e67c00;
      }
      #passModal button[type="button"]:hover {
        background: #ddd;
      }
    </style>
  </div>

  <!-- Scripts -->
  <script src="assets/js/data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>  
  <script src="assets/js/articles.js"></script>
  <script src="assets/js/categories.js"></script>
  <script src="assets/js/languages.js"></script>
  <script src="assets/js/users.js"></script>
  <script src="assets/js/analytics-dashboard.js"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // TODO: Fill in your Firebase config below
    const firebaseConfig = {
      apiKey: "AIzaSyBIkMsj6iQoUNoywiS3oBp4PUWKReSnX2w",
      authDomain: "modern-media-d38df.firebaseapp.com",
      projectId: "modern-media-d38df",
      storageBucket: "modern-media-d38df.appspot.com",
      messagingSenderId: "514430170094",
      appId: "1:514430170094:web:d0f30c9f3a946cd256d4ff"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Firestore CRUD helpers ---
    // Articles
    async function getArticlesFS() {
      const snap = await db.collection('articles').orderBy('publishDate', 'desc').get();
      return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }
    async function saveArticleFS(article) {
      try {
        const result = await db.collection('articles').add(article);
        console.log('Article saved to Firestore with ID:', result.id);
        alert('Article saved to Firestore! ID: ' + result.id);
        return result;
      } catch (err) {
        console.error('Error saving article to Firestore:', err);
        alert('Error saving article to Firestore: ' + (err && err.message ? err.message : err));
        throw err;
      }
    }
    // Carousel Images
    async function getCarouselImagesFS() {
      const doc = await db.collection('meta').doc('carouselImages').get();
      return doc.exists ? doc.data().images || [] : [];
    }
    async function setCarouselImagesFS(images) {
      await db.collection('meta').doc('carouselImages').set({ images });
    }
    // Make Firestore helpers globally available
    window.saveArticleFS = saveArticleFS;
    window.getArticlesFS = getArticlesFS;
    window.getCarouselImagesFS = getCarouselImagesFS;
    window.setCarouselImagesFS = setCarouselImagesFS;
  </script>

  <!-- Dynamic Section Loader -->
  <script>
    // Dummy data for metrics and charts
    const metrics = {
      articles: 120,
      categories: 5,
      languages: 3,
      users: 42
    };
    const articlesByLanguage = {
      labels: ['English', 'Hindi', 'Gujarati'],
      data: [50, 40, 30]
    };
    const articlesByCategory = {
      labels: ['Technology', 'Environment', 'Business', 'Sports'],
      data: [40, 20, 20, 20]
    };
    const recentPosts = [
      { title: 'Tech Innovation in 2025', date: '21 June 2025' },
      { title: 'Climate Change: The Next Decade', date: '20 June 2025' },
      { title: 'Business Trends to Watch', date: '19 June 2025' },
      { title: 'Sports Highlights: June', date: '18 June 2025' },
      { title: 'New Language Support Added', date: '17 June 2025' }
    ];

    // --- Article Storage Helpers ---
    function getArticles() {
      return JSON.parse(localStorage.getItem('articles') || '[]');
    }
    function saveArticle(article) {
      const articles = getArticles();
      articles.unshift(article); // add to start
      localStorage.setItem('articles', JSON.stringify(articles));
    }
    // --- Dashboard Render (uses Firestore) ---
    async function renderInitialDashboard() {
      const articles = await getArticlesFS();
      document.getElementById('total-articles').textContent = articles.length;
      document.getElementById('total-categories').textContent = metrics.categories;
      document.getElementById('total-languages').textContent = metrics.languages;
      document.getElementById('total-users').textContent = metrics.users;
      // Chart rendering logic (dummy, can be improved to use real data)
      new Chart(document.getElementById('langBarChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: articlesByLanguage.labels,
          datasets: [{
            label: 'Articles',
            data: articlesByLanguage.data,
            backgroundColor: ['#FF9800', '#2196F3', '#43A047']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
      new Chart(document.getElementById('catPieChart').getContext('2d'), {
        type: 'pie',
        data: {
          labels: articlesByCategory.labels,
          datasets: [{
            data: articlesByCategory.data,
            backgroundColor: ['#FF9800', '#2196F3', '#43A047', '#888']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } }
        }
      });
      // Render recent posts from Firestore
      const postsList = document.getElementById('recent-posts-list');
      postsList.innerHTML = '';
      articles.slice(0, 5).forEach((post, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `${post.title} (${post.publishDate || 'No date'}) <a href="index.html?article=${idx}" target="_blank" style="color:#2196F3;text-decoration:underline;font-size:0.97em;margin-left:8px;">View</a>`;
        postsList.appendChild(li);
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Helper: Remove active from all sidebar links
      function clearSidebarActive() {
        document.querySelectorAll('.admin-sidebar nav a').forEach(l => l.classList.remove('active'));
      }
      // Helper: Set active link by hash
      function setSidebarActive(hash) {
        const link = document.querySelector('.admin-sidebar nav a[href="' + hash + '"]');
        if (link) link.classList.add('active');
      }
      // Section loader
      function loadSection(hash) {
        switch (hash) {
          case '#dashboard':
            document.getElementById('admin-main').innerHTML = `
              <section class="dashboard-grid">
                <div class="metric-card orange">
                  <div class="icon"><i class="fas fa-book"></i></div>
                  <div class="metric-value" id="total-articles">0</div>
                  <div class="metric-label">Total Articles</div>
                  <div class="metric-subtext">Number of published articles</div>
                </div>
                <div class="metric-card blue">
                  <div class="icon"><i class="fas fa-folder"></i></div>
                  <div class="metric-value" id="total-categories">0</div>
                  <div class="metric-label">Categories</div>
                  <div class="metric-subtext">Number of news categories</div>
                </div>
                <div class="metric-card green">
                  <div class="icon"><i class="fas fa-globe"></i></div>
                  <div class="metric-value" id="total-languages">0</div>
                  <div class="metric-label">Languages</div>
                  <div class="metric-subtext">Number of supported languages</div>
                </div>
                <div class="metric-card gray">
                  <div class="icon"><i class="fas fa-users"></i></div>
                  <div class="metric-value" id="total-users">0</div>
                  <div class="metric-label">Registered Users</div>
                  <div class="metric-subtext">Total registered users (dummy)</div>
                </div>
              </section>
              <section class="dashboard-charts">
                <div class="chart-card">
                  <h3>Articles by Language</h3>
                  <canvas id="langBarChart"></canvas>
                </div>
                <div class="chart-card">
                  <h3>Articles by Category</h3>
                  <canvas id="catPieChart"></canvas>
                </div>
              </section>
              <section class="recent-posts">
                <h3>Recent Posts</h3>
                <ul id="recent-posts-list"></ul>
              </section>
            `;
            if (typeof renderInitialDashboard === 'function') renderInitialDashboard();
            break;
          case '#articles':
            // Inject the article form directly (no fetch)
            const classicStyle = `
              <style>
                .classic-article-form { max-width: 600px; margin: 2.5rem auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 16px #0002; padding: 2.5rem 2rem 2rem 2rem; font-family: 'Segoe UI', Arial, sans-serif; border: 1px solid #e0e0e0; }
                .classic-article-form h2 { text-align: center; color: #2196F3; font-size: 2rem; margin-bottom: 1.5rem; font-weight: 700; letter-spacing: 1px; }
                .classic-article-form label { font-weight: 600; margin-bottom: 0.3rem; display: block; color: #333; }
                .classic-article-form input[type="text"], .classic-article-form input[type="date"], .classic-article-form select, .classic-article-form textarea { width: 100%; padding: 10px 12px; border: 1px solid #bbb; border-radius: 5px; font-size: 1rem; margin-bottom: 1.1rem; background: #fafbfc; transition: border 0.2s; }
                .classic-article-form input[type="text"]:focus, .classic-article-form input[type="date"]:focus, .classic-article-form select:focus, .classic-article-form textarea:focus { border-color: #2196F3; outline: none; }
                .classic-article-form textarea { min-height: 120px; resize: vertical; }
                .classic-article-form .form-row { display: flex; gap: 1.2rem; }
                .classic-article-form .form-row > div { flex: 1; }
                .classic-article-form .toggle-group { display: flex; gap: 1.5rem; margin-bottom: 1.2rem; }
                .classic-article-form .toggle-group label { font-weight: 400; color: #444; display: flex; align-items: center; gap: 0.4rem; }
                .classic-article-form .image-upload { border: 1.5px dashed #bbb; padding: 1.2rem; text-align: center; border-radius: 6px; color: #888; background: #fafbfc; margin-bottom: 0.7rem; position: relative; }
                .classic-article-form .image-upload input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; left: 0; top: 0; cursor: pointer; }
                .classic-article-form .preview-text { margin-top: 0.5rem; font-size: 0.97rem; color: #2196F3; }
                .classic-article-form .divider { border-bottom: 1px solid #eee; margin: 1.5rem 0 1.2rem 0; }
                .classic-article-form .btn-publish { background: #2196F3; color: #fff; border: none; border-radius: 5px; padding: 0.85rem 0; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 0.7rem; transition: background 0.2s; }
                .classic-article-form .btn-publish:hover { background: #1769aa; }
                @media (max-width: 700px) { .classic-article-form { padding: 1.2rem 0.5rem; } .classic-article-form .form-row { flex-direction: column; gap: 0; } }
              </style>
            `;
            let classicForm = `<div class="classic-article-form">
              <h2>Publish New Article</h2>
              <form id="articleForm">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" required placeholder="Enter article title" />
                <label for="content">Content (Markdown Supported)</label>
                <textarea id="content" name="content" required placeholder="Write your article content here..."></textarea>
                <div class="divider"></div>
                <div class="form-row">
                  <div>
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                      <option value="रिपोर्ट">रिपोर्ट</option>
                      <option value="राजनीति">राजनीति</option>
                      <option value="विचार">विचार</option>
                      <option value="देश-समाज">देश-समाज</option>
                      <option value="फ़ैक्ट-चेक">फ़ैक्ट-चेक</option>
                      <option value="विविध विषय">विविध विषय</option>
                    </select>
                  </div>
                  <div>
                    <label for="language">Language</label>
                    <select id="language" name="language">
                      <option value="English">English</option>
                      <option value="Hindi">Hindi</option>
                      <option value="Gujarati">Gujarati</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div>
                    <label for="author">Author Name</label>
                    <input type="text" id="author" name="author" value="Admin User" readonly />
                  </div>
                  <div>
                    <label for="tags">Tags (comma-separated)</label>
                    <input type="text" id="tags" name="tags" placeholder="politics, news" />
                  </div>
                </div>
                <label for="publishDate">Publish Date</label>
                <input type="date" id="publishDate" name="publishDate" />
                <div class="toggle-group">
                  <label><input type="checkbox" name="trending" /> Trending</label>
                  <label><input type="checkbox" name="breakingNews" /> Breaking News</label>
                </div>
                <label>Featured Image</label>
                <div class="image-upload">
                  <span id="imageLabel">No image selected</span>
                  <input type="file" id="image" name="image" accept="image/*" />
                </div>
                <div id="imagePreview" class="preview-text"></div>
                <button type="submit" class="btn-publish">Publish Article</button>
              </form>
              <div class="divider"></div>
              <h3 style='text-align:center;margin:1.5rem 0 1rem 0;font-size:1.2rem;color:#2196F3;'>All Articles</h3>
              <div id="articlesList"></div>
              <div class="divider"></div>
              <h2 style='text-align:center;color:#FF9800;font-size:1.3rem;margin:2.5rem 0 1.2rem 0;'>Carousel Images</h2>
              <form id="carouselForm" style='margin-bottom:1.5rem;'>
                <label style='font-weight:600;'>Add Images for Top Carousel (max 6)</label>
                <input type="file" id="carouselImagesInput" accept="image/*" multiple style='margin-bottom:1rem;'>
                <div id="carouselImagesPreview" style='display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.7rem;'></div>
                <button type="submit" class="btn-publish" style='background:#FF9800;margin-top:1.2rem;'>Save Carousel Images</button>
              </form>
            </div>`;
            document.getElementById('admin-main').innerHTML = classicStyle + classicForm;
            // Attach all handlers after DOM update
            setTimeout(() => {
              const categorySelect = document.getElementById('category');
              const imageInput = document.getElementById('image');
              const imageLabel = document.getElementById('imageLabel');
              const imagePreview = document.getElementById('imagePreview');
              const form = document.getElementById('articleForm');
              const articlesList = document.getElementById('articlesList');
              const carouselImagesInput = document.getElementById('carouselImagesInput');
              const carouselImagesPreview = document.getElementById('carouselImagesPreview');
              const carouselForm = document.getElementById('carouselForm');
              let imageBase64 = '';
              async function fetchCategories() {
                let categories = await window.getCategoriesFS();
                const mustHave = [
                  'रिपोर्ट','राजनीति','विचार','देश-समाज','फ़ैक्ट-चेक','विविध विषय','और भी...','सहयोग करें',
                  'Technology','Business','Sports','Environment','Politics','Education'
                ];
                let changed = false;
                mustHave.forEach(cat => {
                  if (!categories.includes(cat)) { categories.push(cat); changed = true; }
                });
                if (changed || !categories.length) await window.setCategoriesFS(categories);
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                  const option = document.createElement('option');
                  option.value = cat;
                  option.textContent = cat;
                  categorySelect.appendChild(option);
                });
              }
              categorySelect.addEventListener('focus', fetchCategories);
              function resizeImage(file, maxWidth = 1200, maxSizeKB = 200) {
                return new Promise((resolve, reject) => {
                  const img = new window.Image();
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    img.onload = function() {
                      let width = img.width;
                      let height = img.height;
                      if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                      }
                      const canvas = document.createElement('canvas');
                      canvas.width = width;
                      canvas.height = height;
                      const ctx = canvas.getContext('2d');
                      ctx.drawImage(img, 0, 0, width, height);
                      let quality = 0.92;
                      let dataUrl = canvas.toDataURL('image/jpeg', quality);
                      while (dataUrl.length / 1024 > maxSizeKB && quality > 0.5) {
                        quality -= 0.07;
                        dataUrl = canvas.toDataURL('image/jpeg', quality);
                      }
                      resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                  };
                  reader.onerror = reject;
                  reader.readAsDataURL(file);
                });
              }
              imageInput.addEventListener('change', async function() {
                if (imageInput.files.length > 0) {
                  imageLabel.textContent = 'Selected: ' + imageInput.files[0].name;
                  try {
                    imageBase64 = await resizeImage(imageInput.files[0]);
                    imagePreview.innerHTML = '<img src="' + imageBase64 + '" style="max-width:120px;max-height:80px;border-radius:6px;box-shadow:0 2px 8px #0001;">';
                  } catch (err) {
                    imageLabel.textContent = 'Image load failed';
                    imageBase64 = '';
                    imagePreview.innerHTML = '';
                  }
                } else {
                  imageLabel.textContent = 'No image selected';
                  imageBase64 = '';
                  imagePreview.innerHTML = '';
                }
              });
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                const data = {};
                formData.forEach(function(value, key) {
                  if (key === 'image') return; // skip raw file
                  if (key === 'trending' || key === 'breakingNews') {
                    data[key] = formData.has(key);
                  } else {
                    data[key] = value;
                  }
                });
                if (imageBase64) data.img = imageBase64;
                try {
                  await window.saveArticleFS(data);
                  alert('Article submitted successfully!');
                  form.reset();
                  imageLabel.textContent = 'No image selected';
                  imagePreview.innerHTML = '';
                  imageBase64 = '';
                  renderArticlesList();
                } catch (err) {
                  alert('Failed to publish article. ' + (err && err.message ? err.message : err));
                  console.error('Firestore error:', err);
                }
              });
              async function renderArticlesList() {
                const articles = await window.getArticlesFS();
                if (!articles.length) { articlesList.innerHTML = '<div style="color:#888;text-align:center;">No articles yet.</div>'; return; }
                var html = '<table style="width:100%;border-collapse:collapse;font-size:0.98rem;">';
                html += '<tr style="background:#f5f5f5;"><th style="padding:8px 4px;border-bottom:1px solid #eee;">Title</th><th style="padding:8px 4px;border-bottom:1px solid #eee;">Category</th><th style="padding:8px 4px;border-bottom:1px solid #eee;">Language</th><th style="padding:8px 4px;border-bottom:1px solid #eee;">Publish Date</th><th style="padding:8px 4px;border-bottom:1px solid #eee;">View</th></tr>';
                articles.forEach(function(a, idx) {
                  html += '<tr>' +
                    '<td style="padding:7px 4px;border-bottom:1px solid #f0f0f0;">' + a.title + '</td>' +
                    '<td style="padding:7px 4px;border-bottom:1px solid #f0f0f0;">' + a.category + '</td>' +
                    '<td style="padding:7px 4px;border-bottom:1px solid #f0f0f0;">' + a.language + '</td>' +
                    '<td style="padding:7px 4px;border-bottom:1px solid #f0f0f0;">' + (a.publishDate || '') + '</td>' +
                    '<td style="padding:7px 4px;border-bottom:1px solid #f0f0f0;"><a href="index.html?article=' + a.id + '" target="_blank" style="color:#2196F3;text-decoration:underline;font-weight:500;">View</a></td>' +
                    '</tr>';
                });
                html += '</table>';
                articlesList.innerHTML = html;
              }
              // Carousel Images
              async function renderCarouselImagesPreview() {
                const imgs = await window.getCarouselImagesFS();
                carouselImagesPreview.innerHTML = '';
                imgs.forEach(function(img, idx) {
                  var div = document.createElement('div');
                  div.style.position = 'relative';
                  div.innerHTML = '<img src="' + img + '" style="width:110px;height:60px;object-fit:cover;border-radius:6px;box-shadow:0 2px 8px #0001;"><button data-idx="' + idx + '" style="position:absolute;top:2px;right:2px;background:#fff;color:#e53935;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-weight:bold;font-size:1.1em;">×</button>';
                  carouselImagesPreview.appendChild(div);
                });
              }
              async function renderCarouselImagesList() {
                const imgs = await window.getCarouselImagesFS();
                let html = '';
                if (!imgs.length) {
                  html = '<div style="color:#888;text-align:center;">No carousel images yet.</div>';
                } else {
                  html = '<div style="display:flex;flex-wrap:wrap;gap:1.2rem;justify-content:center;">';
                  imgs.forEach((img, idx) => {
                    html += `<div style='position:relative;display:inline-block;'>
                      <img src='${img}' style='width:120px;height:70px;object-fit:cover;border-radius:7px;box-shadow:0 2px 8px #0001;'>
                      <button data-idx='${idx}' style='position:absolute;top:2px;right:2px;background:#fff;color:#e53935;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-weight:bold;font-size:1.1em;'>×</button>
                    </div>`;
                  });
                  html += '</div>';
                }
                let listDiv = document.getElementById('carouselImagesList');
                if (!listDiv) {
                  listDiv = document.createElement('div');
                  listDiv.id = 'carouselImagesList';
                  carouselForm.parentNode.insertBefore(listDiv, carouselForm.nextSibling);
                }
                listDiv.innerHTML = html;
              }
              carouselImagesPreview.addEventListener('click', async function(e) {
                if (e.target.tagName === 'BUTTON') {
                  const idx = +e.target.getAttribute('data-idx');
                  let imgs = await window.getCarouselImagesFS();
                  imgs.splice(idx, 1);
                  await window.setCarouselImagesFS(imgs);
                  renderCarouselImagesPreview();
                  renderCarouselImagesList();
                }
              });
              carouselImagesInput.addEventListener('change', async function() {
                const files = Array.from(carouselImagesInput.files);
                if (!files.length) return;
                let imgs = await window.getCarouselImagesFS();
                if (imgs.length + files.length > 6) {
                  alert('Maximum 6 images allowed in carousel.');
                  return;
                }
                for (const file of files) {
                  try {
                    const resized = await resizeImage(file, 1200, 200);
                    imgs.push(resized);
                  } catch (err) {
                    alert('Failed to process image: ' + file.name);
                  }
                }
                await window.setCarouselImagesFS(imgs);
                renderCarouselImagesPreview();
                renderCarouselImagesList();
                carouselImagesInput.value = '';
              });
              carouselForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                alert('Carousel images saved!');
                renderCarouselImagesPreview();
                renderCarouselImagesList();
              });
              // Initial load
              fetchCategories();
              renderArticlesList();
              renderCarouselImagesPreview();
              renderCarouselImagesList();
            }, 0);
            break;
          case '#categories':
            if (typeof window.renderCategories === 'function') window.renderCategories();
            else showNotFound();
            break;
          case '#languages':
            if (typeof window.renderLanguages === 'function') window.renderLanguages();
            else showNotFound();
            break;
          case '#users':
            if (typeof window.renderUsers === 'function') window.renderUsers();
            else showNotFound();
            break;
          case '#analytics':
            // Dynamically load analytics dashboard HTML and initialize JS
            fetch('assets/html/analytics-dashboard.html')
              .then(res => res.text())
              .then(html => {
                document.getElementById('admin-main').innerHTML = html;
                // Always load the analytics-dashboard.js script after HTML injection
                const script = document.createElement('script');
                script.src = 'assets/js/analytics-dashboard.js';
                script.onload = function() {
                  if (window.initAnalyticsDashboard) {
                    window.initAnalyticsDashboard();
                  } else if (window.renderAnalyticsDashboard) {
                    window.renderAnalyticsDashboard();
                  }
                };
                document.body.appendChild(script);
              })
              .catch(() => {
                showNotFound();
              });
            break;
          default:
            showNotFound();
        }
      }
      function showNotFound() {
        document.getElementById('admin-main').innerHTML = `
          <div style="padding:2rem;text-align:center;">
            Section not found or not implemented yet.
          </div>`;
      }
      // Sidebar click handler
      document.querySelectorAll('.admin-sidebar nav a').forEach(link => {
        link.addEventListener('click', function (e) {
          const hash = this.getAttribute('href');
          if (!hash.startsWith('#')) return;
          e.preventDefault();
          clearSidebarActive();
          setSidebarActive(hash);
          loadSection(hash);
        });
      });
      // On page load: load section from hash or dashboard
      let initialHash = window.location.hash;
      if (!initialHash || !document.querySelector('.admin-sidebar nav a[href="' + initialHash + '"]')) {
        initialHash = '#dashboard';
      }
      clearSidebarActive();
      setSidebarActive(initialHash);
      loadSection(initialHash);
    });

    // Password modal handlers
    document.getElementById('openPassModal').addEventListener('click', function() {
      document.getElementById('passModalBackdrop').style.display = 'block';
      document.getElementById('passModal').style.display = 'block';
    });
    document.getElementById('closePassModal').addEventListener('click', function() {
      document.getElementById('passModalBackdrop').style.display = 'none';
      document.getElementById('passModal').style.display = 'none';
    });
    document.getElementById('changePassFormModal').addEventListener('submit', async function(e) {
      e.preventDefault();
      const oldPass = document.getElementById('oldPassModal').value;
      const newPass = document.getElementById('newPassModal').value;
      const confirmPass = document.getElementById('confirmPassModal').value;
      if (newPass !== confirmPass) {
        alert('New password and confirmation do not match.');
        return;
      }
      // TODO: Implement actual password change logic
      document.getElementById('changeMsgModal').textContent = 'Password changed successfully!';
      setTimeout(() => {
        document.getElementById('passModalBackdrop').style.display = 'none';
        document.getElementById('passModal').style.display = 'none';
      }, 1500);
    });
    // Password Change Modal Logic
    document.addEventListener('DOMContentLoaded', function () {
      const openBtn = document.getElementById('openPassModal');
      const modal = document.getElementById('passModal');
      const backdrop = document.getElementById('passModalBackdrop');
      const closeBtn = document.getElementById('closePassModal');
      const form = document.getElementById('changePassFormModal');
      const msg = document.getElementById('changeMsgModal');
      if (openBtn && modal && backdrop && closeBtn && form && msg) {
        openBtn.onclick = function() {
          modal.style.display = 'block';
          backdrop.style.display = 'block';
          msg.textContent = '';
          form.reset();
        };
        closeBtn.onclick = function() {
          modal.style.display = 'none';
          backdrop.style.display = 'none';
        };
        backdrop.onclick = function() {
          modal.style.display = 'none';
          backdrop.style.display = 'none';
        };
        // Password Change Modal Logic (now uses Firestore)
        form.onsubmit = async function(e) {
          e.preventDefault();
          const oldPass = document.getElementById('oldPassModal').value;
          const newPass = document.getElementById('newPassModal').value;
          const confirmPass = document.getElementById('confirmPassModal').value;
          msg.textContent = '';
          msg.style.color = 'red';
          // Fetch current password from Firestore
          let passDoc = await db.collection('meta').doc('adminPassword').get();
          let stored = passDoc.exists ? passDoc.data().password : 'modern@2025';
          if (oldPass !== stored) {
            msg.textContent = 'Current password is incorrect!';
            return;
          }
          if (newPass.length < 4) {
            msg.textContent = 'New password must be at least 4 characters.';
            return;
          }
          if (newPass !== confirmPass) {
            msg.textContent = 'New passwords do not match!';
            return;
          }
          // Save new password to Firestore
          await db.collection('meta').doc('adminPassword').set({ password: newPass });
          msg.textContent = 'Password changed successfully!';
          msg.style.color = 'green';
          setTimeout(() => {
            modal.style.display = 'none';
            backdrop.style.display = 'none';
          }, 1200);
        };
      }
    });
  </script>

  <!-- Firestore Security Rules (for reference, not executable here) -->
  <script type="text/firestore-rules">
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} {
          allow read, write: if true;
        }
      }
    }
  </script>
</body>
</html>
